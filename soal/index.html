<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="Ø§Ø®ØªØ¨Ø§Ø± ØªÙØ§Ø¹Ù„ÙŠ ÙÙŠ Ø§Ù„ÙÙ‚Ù‡ ÙˆØ§Ù„Ø£ØµÙˆÙ„ Ù…Ø¹ ØªØªØ¨Ø¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙÙ‚Ù‡ ÙˆØ§Ù„Ø£ØµÙˆÙ„</title>
    <!-- Importing Tajawal Font for Arabic -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-color: #1f2937;
            --success-color: #10b981;
            --error-color: #ef4444;
            --border-radius: 12px;
            --input-border: #d1d5db;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: var(--card-bg);
            width: 100%;
            max-width: 700px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 500px;
            /* Increased height for extra input */
            position: relative;
        }

        /* --- Common Elements --- */
        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-family: inherit;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-block;
        }

        .btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-1px);
        }

        .btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        h2 {
            margin-bottom: 20px;
        }

        /* --- Screens --- */
        .screen {
            padding: 40px;
            display: none;
            /* Hidden by default */
            flex-direction: column;
            height: 100%;
            flex-grow: 1;
        }

        .active-screen {
            display: flex;
        }

        /* 1. Loading & Error */
        #loading-screen,
        #error-screen {
            text-align: center;
            justify-content: center;
            align-items: center;
        }

        /* 2. Selection Screen */
        #selection-screen {
            justify-content: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-color);
        }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            background-color: white;
            cursor: pointer;
            outline: none;
        }

        .form-select:focus {
            border-color: var(--primary-color);
        }

        .form-select:disabled {
            background-color: #f9fafb;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* 3. Quiz Screen */
        #quiz-screen {
            padding: 0;
        }

        .quiz-header {
            padding: 20px;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .progress-bar {
            height: 6px;
            background-color: #e5e7eb;
            width: 100%;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--success-color);
            width: 0%;
            transition: width 0.3s ease;
        }

        .quiz-content {
            padding: 30px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .meta-info {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .question-text {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .choices-grid {
            display: grid;
            gap: 12px;
        }

        .choice-btn {
            background: white;
            border: 2px solid #e5e7eb;
            padding: 15px 20px;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1.1rem;
            text-align: right;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-color);
        }

        .choice-btn:hover:not(:disabled) {
            border-color: var(--primary-color);
            background-color: #eff6ff;
        }

        .choice-btn.correct {
            background-color: #d1fae5 !important;
            border-color: var(--success-color) !important;
            color: #065f46;
        }

        .choice-btn.incorrect {
            background-color: #fee2e2 !important;
            border-color: var(--error-color) !important;
            color: #991b1b;
        }

        .choice-btn:disabled {
            cursor: default;
            opacity: 0.8;
        }

        .quiz-footer {
            padding: 20px 30px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
        }

        /* 4. Result Screen */
        #result-screen {
            text-align: center;
            justify-content: center;
            align-items: center;
        }

        .score-display {
            font-size: 4rem;
            font-weight: 900;
            color: var(--primary-color);
            margin: 20px 0;
        }

        .result-message {
            font-size: 1.5rem;
            margin-bottom: 30px;
        }

        /* --- Keyboard & Focus --- */
        *:focus {
            outline: 3px solid var(--primary-color);
            outline-offset: 2px;
        }

        button:focus {
            outline-offset: 0;
        }

        /* --- Touch Feedback --- */
        .choice-btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        .btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        /* --- Review Items --- */
        .review-item {
            background: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            border-right: 4px solid #d1d5db;
            font-size: 0.9rem;
        }

        .review-item.correct {
            border-right-color: var(--success-color);
        }

        .review-item.incorrect {
            border-right-color: var(--error-color);
        }

        .review-item-question {
            font-weight: 600;
            margin-bottom: 6px;
        }

        .review-item-answer {
            color: #6b7280;
            font-size: 0.85rem;
        }

        /* --- High Contrast Mode Support --- */
        @media (prefers-contrast: more) {
            .choice-btn {
                border-width: 3px;
            }

            .btn {
                font-weight: 900;
            }
        }

        /* --- Reduced Motion Support --- */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation: none !important;
                transition: none !important;
            }
        }
    </style>
</head>

<body>

    <div class="container">

        <!-- Screen 1: Loading -->
        <div id="loading-screen" class="screen active-screen">
            <h2>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</h2>
        </div>

        <!-- Screen 2: Error -->
        <div id="error-screen" class="screen" tabindex="-1" role="alert">
            <h2 style="color: var(--error-color)">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</h2>
            <p id="error-details"></p>
            <p>ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ ÙÙŠ Ù…Ø¬Ù„Ø¯ "questions".</p>
            <button id="retry-btn" class="btn" style="margin-top: 20px;">Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø©</button>
        </div>

        <!-- Screen 3: Selection -->
        <div id="selection-screen" class="screen" tabindex="-1" role="main">
            <h2 style="text-align: center;">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>

            <!-- Resume Quiz Section -->
            <div id="resume-section"
                style="display: none; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <h3 style="margin-top: 0; color: #d97706;">Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ØŸ</h3>
                <p id="resume-info"></p>
                <button id="resume-btn" class="btn" style="margin-right: 10px;">Ø§Ø³ØªØ¦Ù†Ø§Ù</button>
                <button id="new-quiz-btn" class="btn" style="background-color: #6b7280;">Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯</button>
            </div>

            <div class="form-group">
                <label class="form-label" for="book-select">Ø§Ø®ØªØ± Ø§Ù„ÙƒØªØ§Ø¨:</label>
                <select id="book-select" class="form-select" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒØªØ§Ø¨">
                    <option value="" disabled selected>-- Ø§Ø®ØªØ± Ø§Ù„ÙƒØªØ§Ø¨ --</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="chapter-select">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ø¨ / Ø§Ù„ÙØµÙ„:</label>
                <select id="chapter-select" class="form-select" disabled aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨Ø§Ø¨ Ø£Ùˆ Ø§Ù„ÙØµÙ„">
                    <option value="" disabled selected>-- ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒØªØ§Ø¨ Ø£ÙˆÙ„Ø§Ù‹ --</option>
                </select>
            </div>

            <!-- Sub-Chapter Selection -->
            <div class="form-group">
                <label class="form-label" for="sub-chapter-select">Ø§Ù„Ù…Ø¨Ø­Ø« / Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                <select id="sub-chapter-select" class="form-select" disabled aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¨Ø­Ø« Ø£Ùˆ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹">
                    <option value="" disabled selected>-- Ø§Ù„ÙƒÙ„ --</option>
                </select>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button id="start-quiz-btn" class="btn" disabled>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
            </div>
            <p id="question-count-hint"
                style="text-align: center; margin-top: 10px; color: #6b7280; font-size: 0.9rem;"></p>
        </div>

        <!-- Screen 4: Quiz -->
        <div id="quiz-screen" class="screen" tabindex="-1" role="main">
            <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"
                aria-label="ØªÙ‚Ø¯Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±">
                <div class="progress-fill" id="progress-fill"></div>
            </div>

            <div class="quiz-header">
                <span class="badge" id="category-badge" aria-label="Ø§Ù„ÙØ¦Ø©">...</span>
                <span class="badge" aria-live="polite">Ø³Ø¤Ø§Ù„ <span id="current-num">1</span> Ù…Ù† <span
                        id="total-num">0</span></span>
            </div>

            <div class="quiz-content">
                <div class="meta-info">
                    <span id="book-info">ğŸ“˜ Ø§Ù„ÙƒØªØ§Ø¨</span>
                    <span id="page-info">ğŸ“„ ØµÙØ­Ø© 0</span>
                </div>
                <h3 class="question-text" id="question-text" role="heading" aria-level="2">...</h3>
                <div class="choices-grid" id="choices-container" role="group" aria-label="Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©">
                    <!-- Choices injected here -->
                </div>
            </div>

            <div class="quiz-footer">
                <button class="btn" id="next-btn" style="display: none;">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ</button>
            </div>
        </div>

        <!-- Screen 5: Result -->
        <div id="result-screen" class="screen" tabindex="-1" role="main">
            <h2>Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
            <div class="score-display" aria-label="Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©">
                <span id="final-score">0</span> / <span id="total-score">0</span>
            </div>
            <p class="result-message" id="result-message" role="status">...</p>

            <!-- Review Section -->
            <div id="review-section"
                style="max-height: 300px; overflow-y: auto; margin: 20px 0; padding: 15px; background: #f9fafb; border-radius: 8px; display: none;">
                <h3 style="margin-top: 0;">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</h3>
                <div id="review-container"></div>
            </div>

            <button class="btn" id="show-review-btn" style="margin-right: 10px; display: none;">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
            <button class="btn" id="restart-btn">Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯</button>
        </div>

    </div>

    <script>
        // --- State Management ---
        let allData = [];
        let quizQuestions = [];
        let userAnswers = []; // Track user answers for review
        let currentQuestionIndex = 0;
        let score = 0;
        let isAnswered = false;
        let loadRetries = 3;
        let isQuizInProgress = false;

        // --- DOM Elements ---
        const screens = {
            loading: document.getElementById('loading-screen'),
            error: document.getElementById('error-screen'),
            selection: document.getElementById('selection-screen'),
            quiz: document.getElementById('quiz-screen'),
            result: document.getElementById('result-screen')
        };

        const inputs = {
            book: document.getElementById('book-select'),
            chapter: document.getElementById('chapter-select'),
            subChapter: document.getElementById('sub-chapter-select'),
            startBtn: document.getElementById('start-quiz-btn'),
            hint: document.getElementById('question-count-hint'),
            retryBtn: document.getElementById('retry-btn'),
            resumeBtn: document.getElementById('resume-btn'),
            newQuizBtn: document.getElementById('new-quiz-btn'),
            resumeSection: document.getElementById('resume-section')
        };

        const quizUI = {
            progress: document.getElementById('progress-fill'),
            currentNum: document.getElementById('current-num'),
            totalNum: document.getElementById('total-num'),
            category: document.getElementById('category-badge'),
            book: document.getElementById('book-info'),
            page: document.getElementById('page-info'),
            text: document.getElementById('question-text'),
            choices: document.getElementById('choices-container'),
            nextBtn: document.getElementById('next-btn')
        };

        const resultUI = {
            finalScore: document.getElementById('final-score'),
            totalScore: document.getElementById('total-score'),
            message: document.getElementById('result-message'),
            restartBtn: document.getElementById('restart-btn'),
            reviewSection: document.getElementById('review-section'),
            reviewContainer: document.getElementById('review-container'),
            showReviewBtn: document.getElementById('show-review-btn')
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            attachEventListeners();
            checkForSavedProgress();
            addBeforeUnloadWarning();
        });

        // --- 1. Data Loading with Retry & Validation ---
        async function loadData(retries = loadRetries) {
            try {
                // 1. Fetch the list of question files (manifest)
                const indexResponse = await fetch('questions/index.json', {
                    headers: { 'Accept': 'application/json' },
                    cache: 'no-store'
                });
                if (!indexResponse.ok) throw new Error(`Failed to load index: ${indexResponse.status}`);

                const fileList = await indexResponse.json();
                if (!Array.isArray(fileList) || fileList.length === 0) {
                    throw new Error('Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª ÙØ§Ø±ØºØ©');
                }

                // 2. Fetch all files in parallel
                const fetchPromises = fileList.map(filename =>
                    fetch(`questions/${filename}`, { headers: { 'Accept': 'application/json' } })
                        .then(res => {
                            if (!res.ok) throw new Error(`HTTP ${res.status} for ${filename}`);
                            return res.json();
                        })
                );

                const results = await Promise.all(fetchPromises);

                // 3. Merge data
                allData = results.flat();

                if (!Array.isArray(allData) || allData.length === 0) {
                    throw new Error('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ© Ø£Ùˆ ØµÙŠØºØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                }

                // Validate data
                const invalidCount = allData.filter(q => !validateQuestion(q)).length;
                if (invalidCount > 0) {
                    console.warn(`${invalidCount} Ø³Ø¤Ø§Ù„ ØºÙŠØ± ØµØ­ÙŠØ­ ÙÙŠ Ø§Ù„ØµÙŠØºØ©`);
                }

                initSelectionScreen();
            } catch (err) {
                console.error('Error loading data:', err);
                if (retries > 0) {
                    document.getElementById('error-details').textContent =
                        `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„. Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© (${loadRetries - retries + 1}/${loadRetries})...`;
                    setTimeout(() => loadData(retries - 1), 1500);
                } else {
                    showScreen('error');
                    document.getElementById('error-details').textContent = err.message || 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª';
                }
            }
        }

        // Validate question structure
        function validateQuestion(q) {
            const required = ['book', 'chapter', 'question', 'choices', 'answer'];
            if (!required.every(field => q[field] !== undefined && q[field] !== null)) return false;
            if (!Array.isArray(q.choices) || q.choices.length < 2) return false;
            if (!q.choices.includes(q.answer)) return false;
            return true;
        }

        function showScreen(screenName) {
            Object.entries(screens).forEach(([name, el]) => {
                el.classList.remove('active-screen');
                el.setAttribute('aria-hidden', name !== screenName);
            });
            screens[screenName].classList.add('active-screen');
            // Focus management
            setTimeout(() => screens[screenName].focus(), 100);
        }

        // --- 2. Selection Logic ---
        function initSelectionScreen() {
            // Initialize all screens with proper aria-hidden
            Object.entries(screens).forEach(([name, el]) => {
                if (!el.hasAttribute('aria-hidden')) {
                    el.setAttribute('aria-hidden', 'true');
                }
                if (!el.hasAttribute('tabindex')) {
                    el.setAttribute('tabindex', '-1');
                }
                if (!el.hasAttribute('role')) {
                    el.setAttribute('role', 'region');
                }
            });
            showScreen('selection');

            // Extract unique Books
            const books = [...new Set(allData.map(q => q.book))].filter(Boolean);

            inputs.book.innerHTML = '<option value="" disabled selected>-- Ø§Ø®ØªØ± Ø§Ù„ÙƒØªØ§Ø¨ --</option>';
            books.forEach(book => {
                const option = document.createElement('option');
                option.value = book;
                option.textContent = book;
                inputs.book.appendChild(option);
            });

            resetChapterSelect();
        }

        function resetChapterSelect() {
            inputs.chapter.innerHTML = '<option value="" disabled selected>-- ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒØªØ§Ø¨ Ø£ÙˆÙ„Ø§Ù‹ --</option>';
            inputs.chapter.disabled = true;
            resetSubChapterSelect(true); // Cascade reset
        }

        function resetSubChapterSelect(fullDisable = false) {
            inputs.subChapter.innerHTML = '<option value="" disabled selected>-- Ø§Ù„ÙƒÙ„ --</option>';
            inputs.subChapter.disabled = true;
            inputs.startBtn.disabled = true;
            inputs.hint.textContent = "";
        }

        function updateQuestionCount() {
            const count = getFilteredQuestions().length;
            inputs.startBtn.disabled = count === 0;
            inputs.hint.textContent = count > 0
                ? `Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©: ${count}`
                : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±";
        }

        // Attach event listeners for new features
        function attachEventListeners() {
            inputs.retryBtn?.addEventListener('click', () => loadData());
            inputs.resumeBtn?.addEventListener('click', resumeSavedQuiz);
            inputs.newQuizBtn?.addEventListener('click', () => {
                localStorage.removeItem('quizProgress');
                inputs.resumeSection.style.display = 'none';
                initSelectionScreen();
            });
            document.addEventListener('keydown', handleKeyboardNavigation);
            resultUI.showReviewBtn?.addEventListener('click', () => {
                resultUI.reviewSection.style.display = resultUI.reviewSection.style.display === 'none' ? 'block' : 'none';
                resultUI.showReviewBtn.textContent = resultUI.reviewSection.style.display === 'none' ? 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' : 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
            });
        }

        // Keyboard navigation
        function handleKeyboardNavigation(e) {
            // Skip if user is typing in an input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;

            if (screens.quiz.classList.contains('active-screen')) {
                // Number keys 1-4 for selecting answers
                if (!isAnswered && /^[1-4]$/.test(e.key)) {
                    e.preventDefault();
                    const buttons = quizUI.choices.querySelectorAll('.choice-btn');
                    const index = parseInt(e.key) - 1;
                    if (buttons[index] && !buttons[index].disabled) {
                        buttons[index].click();
                    }
                }
                // Enter or Space for next question
                else if (isAnswered && (e.key === 'Enter' || e.key === ' ')) {
                    e.preventDefault();
                    if (quizUI.nextBtn.style.display !== 'none') {
                        quizUI.nextBtn.click();
                    }
                }
            }
        }

        // Before unload warning
        function addBeforeUnloadWarning() {
            window.addEventListener('beforeunload', (e) => {
                if (isQuizInProgress && !isAnswered) {
                    e.preventDefault();
                    e.returnValue = 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù… ÙŠÙ†ØªÙ‡Ù. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©ØŸ';
                }
            });
        }

        // Check for saved progress and offer to resume
        function checkForSavedProgress() {
            const saved = localStorage.getItem('quizProgress');
            if (saved) {
                try {
                    const progress = JSON.parse(saved);
                    // Only offer if less than 24 hours old
                    if (Date.now() - progress.timestamp < 86400000) {
                        const remaining = progress.quizQuestions.length - progress.currentQuestionIndex;
                        document.getElementById('resume-info').textContent =
                            `Ù„Ø¯ÙŠÙƒ Ø§Ø®ØªØ¨Ø§Ø± ØºÙŠØ± Ù…ÙƒØªÙ…Ù„: ${progress.currentQuestionIndex} Ù…Ù† ${progress.quizQuestions.length} Ø³Ø¤Ø§Ù„ (${remaining} Ù…ØªØ¨Ù‚ÙŠ)`;
                        inputs.resumeSection.style.display = 'block';
                    } else {
                        localStorage.removeItem('quizProgress');
                    }
                } catch (e) {
                    console.error('Error parsing saved progress:', e);
                    localStorage.removeItem('quizProgress');
                }
            }
        }

        // Resume saved quiz
        function resumeSavedQuiz() {
            const saved = localStorage.getItem('quizProgress');
            if (!saved) return;

            const progress = JSON.parse(saved);
            quizQuestions = progress.quizQuestions;
            currentQuestionIndex = progress.currentQuestionIndex;
            score = progress.score;
            userAnswers = progress.userAnswers;

            quizUI.totalNum.textContent = quizQuestions.length;
            inputs.resumeSection.style.display = 'none';
            isQuizInProgress = true;
            showScreen('quiz');
            loadQuestion();
        }

        // Save progress
        function saveProgress() {
            if (!isQuizInProgress) return;
            const progress = {
                quizQuestions,
                currentQuestionIndex,
                score,
                userAnswers,
                timestamp: Date.now()
            };
            localStorage.setItem('quizProgress', JSON.stringify(progress));
        }

        // Event: Book Selected
        inputs.book.addEventListener('change', () => {
            const selectedBook = inputs.book.value;
            const bookQuestions = allData.filter(q => q.book === selectedBook);
            const chapters = [...new Set(bookQuestions.map(q => q.chapter))].filter(Boolean);

            inputs.chapter.innerHTML = '<option value="" disabled selected>-- Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ø¨ / Ø§Ù„ÙØµÙ„ --</option>';

            const allOption = document.createElement('option');
            allOption.value = 'ALL_CHAPTERS';
            allOption.textContent = 'Ø§Ø®ØªØ¨Ø§Ø± ÙÙŠ ÙƒØ§Ù…Ù„ Ø§Ù„ÙƒØªØ§Ø¨';
            inputs.chapter.appendChild(allOption);

            chapters.forEach(chap => {
                const option = document.createElement('option');
                option.value = chap;
                option.textContent = chap;
                inputs.chapter.appendChild(option);
            });

            inputs.chapter.disabled = false;
            resetSubChapterSelect(); // Reset sub-chapters
        });

        // Event: Chapter Selected
        inputs.chapter.addEventListener('change', () => {
            const selectedBook = inputs.book.value;
            const selectedChapter = inputs.chapter.value;

            // 1. Populate Sub-Chapters
            inputs.subChapter.innerHTML = '<option value="ALL_SUB_CHAPTERS" selected>-- ÙƒÙ„ Ø§Ù„Ù…Ø¨Ø§Ø­Ø« / Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹ --</option>';

            if (selectedChapter === 'ALL_CHAPTERS') {
                // If all chapters selected, disable sub-chapter specific selection
                inputs.subChapter.disabled = true;
            } else {
                // Filter sub-chapters for this specific chapter
                const chapterQuestions = allData.filter(q => q.book === selectedBook && q.chapter === selectedChapter);
                const subChapters = [...new Set(chapterQuestions.map(q => q['sub-chapter']))].filter(Boolean);

                if (subChapters.length > 0) {
                    subChapters.forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub;
                        option.textContent = sub;
                        inputs.subChapter.appendChild(option);
                    });
                    inputs.subChapter.disabled = false;
                } else {
                    inputs.subChapter.disabled = true; // No sub-chapters available
                }
            }

            updateQuestionCount();
        });

        // Event: Sub-Chapter Selected
        inputs.subChapter.addEventListener('change', () => {
            updateQuestionCount();
        });

        // Event: Start Button
        inputs.startBtn.addEventListener('click', startQuiz);

        // Save progress periodically during quiz
        setInterval(() => saveProgress(), 5000);


        // --- 3. Quiz Logic ---

        function getFilteredQuestions() {
            const selectedBook = inputs.book.value;
            const selectedChapter = inputs.chapter.value;
            const selectedSubChapter = inputs.subChapter.value;

            let filtered = allData.filter(q => q.book === selectedBook);

            if (selectedChapter !== 'ALL_CHAPTERS') {
                filtered = filtered.filter(q => q.chapter === selectedChapter);

                // Only filter by sub-chapter if a specific chapter is selected AND a specific sub-chapter is selected
                if (selectedSubChapter && selectedSubChapter !== 'ALL_SUB_CHAPTERS') {
                    filtered = filtered.filter(q => q['sub-chapter'] === selectedSubChapter);
                }
            }
            return filtered;
        }

        // Fisher-Yates Shuffle
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startQuiz() {
            const filtered = getFilteredQuestions();
            quizQuestions = shuffleArray([...filtered]);

            if (quizQuestions.length === 0) {
                alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±!");
                return;
            }

            // Reset State
            currentQuestionIndex = 0;
            score = 0;
            userAnswers = [];
            isQuizInProgress = true;
            quizUI.totalNum.textContent = quizQuestions.length;
            inputs.resumeSection.style.display = 'none';
            localStorage.removeItem('quizProgress'); // Clear old progress
            saveProgress(); // Save initial state

            showScreen('quiz');
            loadQuestion();
        }

        function loadQuestion() {
            isAnswered = false;
            quizUI.nextBtn.style.display = 'none';

            const currentQ = quizQuestions[currentQuestionIndex];

            // Update Headers
            quizUI.currentNum.textContent = currentQuestionIndex + 1;

            // Show Sub-Chapter if exists, else Chapter
            const displayCategory = currentQ['sub-chapter']
                ? `${currentQ.chapter} - ${currentQ['sub-chapter']}`
                : currentQ.chapter;

            quizUI.category.textContent = displayCategory;
            quizUI.book.textContent = `ğŸ“˜ ${currentQ.book}`;
            quizUI.page.textContent = currentQ.page ? `ğŸ“„ ØµÙ€ ${currentQ.page}` : '';

            // Progress Bar with accessibility
            const progress = (currentQuestionIndex / quizQuestions.length) * 100;
            quizUI.progress.style.width = `${progress}%`;
            document.querySelector('[role="progressbar"]').setAttribute('aria-valuenow', Math.round(progress));

            // Text
            quizUI.text.textContent = currentQ.question;

            // Choices - shuffle to prevent position memorization
            quizUI.choices.innerHTML = '';
            const choicesToRender = shuffleArray([...currentQ.choices]);

            choicesToRender.forEach(choiceText => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.textContent = choiceText;
                btn.onclick = () => handleAnswer(btn, choiceText, currentQ.answer);
                quizUI.choices.appendChild(btn);
            });
        }

        function handleAnswer(selectedBtn, selectedChoice, correctChoice) {
            if (isAnswered) return;
            isAnswered = true;

            const allButtons = quizUI.choices.querySelectorAll('.choice-btn');
            const isCorrect = selectedChoice === correctChoice;

            // Track answer
            userAnswers.push({
                question: quizQuestions[currentQuestionIndex].question,
                userAnswer: selectedChoice,
                correctAnswer: correctChoice,
                isCorrect: isCorrect,
                book: quizQuestions[currentQuestionIndex].book,
                chapter: quizQuestions[currentQuestionIndex].chapter
            });

            if (isCorrect) {
                selectedBtn.classList.add('correct');
                score++;
            } else {
                selectedBtn.classList.add('incorrect');
                allButtons.forEach(btn => {
                    if (btn.textContent === correctChoice) {
                        btn.classList.add('correct');
                    }
                });
            }

            allButtons.forEach(btn => btn.disabled = true);
            saveProgress();

            if (currentQuestionIndex < quizQuestions.length - 1) {
                quizUI.nextBtn.textContent = "Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ";
                quizUI.nextBtn.onclick = () => {
                    currentQuestionIndex++;
                    loadQuestion();
                };
            } else {
                quizUI.nextBtn.textContent = "Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©";
                quizUI.nextBtn.onclick = finishQuiz;
            }
            quizUI.nextBtn.style.display = 'inline-block';
        }

        // --- 4. Result Logic ---
        function finishQuiz() {
            isQuizInProgress = false;
            localStorage.removeItem('quizProgress');
            saveStatistics();

            showScreen('result');
            quizUI.progress.style.width = '100%';

            resultUI.finalScore.textContent = score;
            resultUI.totalScore.textContent = quizQuestions.length;

            const percentage = (score / quizQuestions.length) * 100;
            if (percentage === 100) {
                resultUI.message.textContent = "Ù…Ù…ØªØ§Ø²! Ø¥Ø¬Ø§Ø¨Ø§Øª ÙƒØ§Ù…Ù„Ø© ØµØ­ÙŠØ­Ø© ğŸŒŸ";
                resultUI.message.style.color = "var(--success-color)";
            } else if (percentage >= 70) {
                resultUI.message.textContent = "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹! Ù†ØªÙŠØ¬Ø© Ø·ÙŠØ¨Ø© âœ…";
                resultUI.message.style.color = "var(--primary-color)";
            } else if (percentage >= 50) {
                resultUI.message.textContent = "Ø¬ÙŠØ¯! Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© ğŸ“–";
                resultUI.message.style.color = "var(--text-color)";
            } else {
                resultUI.message.textContent = "Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ ğŸ“š";
                resultUI.message.style.color = "var(--error-color)";
            }

            // Generate review
            generateReview();
        }

        // Generate review of incorrect answers
        function generateReview() {
            const incorrectAnswers = userAnswers.filter(a => !a.isCorrect);

            if (incorrectAnswers.length > 0) {
                resultUI.showReviewBtn.style.display = 'inline-block';
                resultUI.reviewContainer.innerHTML = '';

                incorrectAnswers.forEach((answer, index) => {
                    const item = document.createElement('div');
                    item.className = 'review-item incorrect';
                    item.innerHTML = `
                        <div class="review-item-question">Ø³Ø¤Ø§Ù„ ${index + 1}: ${answer.question}</div>
                        <div class="review-item-answer">âœ— Ø¥Ø¬Ø§Ø¨ØªÙƒ: <strong>${answer.userAnswer}</strong></div>
                        <div class="review-item-answer">âœ“ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: <strong style="color: var(--success-color);">${answer.correctAnswer}</strong></div>
                    `;
                    resultUI.reviewContainer.appendChild(item);
                });
            } else {
                resultUI.showReviewBtn.style.display = 'none';
            }
        }

        // Save statistics to local storage
        function saveStatistics() {
            const stats = JSON.parse(localStorage.getItem('quizStats') || '[]');
            const percentage = (score / quizQuestions.length) * 100;

            stats.push({
                date: new Date().toISOString(),
                score: score,
                total: quizQuestions.length,
                percentage: Math.round(percentage),
                book: inputs.book.value,
                chapter: inputs.chapter.value !== 'ALL_CHAPTERS' ? inputs.chapter.value : 'ÙƒÙ„ Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨'
            });

            // Keep only last 50 attempts
            if (stats.length > 50) {
                stats.shift();
            }

            localStorage.setItem('quizStats', JSON.stringify(stats));
        }

        resultUI.restartBtn.addEventListener('click', () => {
            // Reset selection inputs
            inputs.book.value = "";
            isQuizInProgress = false;
            userAnswers = [];
            localStorage.removeItem('quizProgress');
            resetChapterSelect();
            initSelectionScreen();
        });

    </script>
    <!-- Features implemented:
    1. âœ“ Accessibility: ARIA labels, roles, focus management, screen reader support
    2. âœ“ Keyboard Navigation: Number keys (1-4) for answers, Enter/Space for next question
    3. âœ“ Error Handling: Retry mechanism with configurable attempts and detailed error messages
    4. âœ“ Local Storage: Save quiz progress, offer resume functionality with 24-hour expiry
    5. âœ“ Data Validation: Validate question structure and content
    6. âœ“ Review Section: Show incorrect answers with corrections at the end
    7. âœ“ Statistics Tracking: Save quiz attempts with scores and dates
    8. âœ“ Mobile UX: Touch feedback, improved focus states, reduced motion support
    9. âœ“ Confirmation Dialogs: Prevent accidental quiz interruption with beforeunload event
    -->
</body>

</html>